{% extends "base.html" %}

{% block title %}Sugerir uma Receita{% endblock %}

{% block head %}
{{ super() }} <!-- Mantém o conteúdo do bloco head do base.html -->
{% endblock %}

{% block content %}
<div class="row justify-content-center suggestions-page">
    <div class="col-12 col-lg-8">
        <h1 class="text-center mb-4">Sugerir uma Nova Receita</h1>
        <p class="text-center text-muted mb-5">Gostamos muito da sua ajuda para fazer crescer a nossa coleção! Por favor, preencha os campos abaixo.</p>

        <!-- Div para mostrar mensagens de sucesso ou erro -->
        <div id="message-display" class="alert d-none" role="alert"></div>

        <form id="suggestion-form" class="form-container shadow-sm">
            <div class="mb-3">
                <label for="nome" class="form-label">Nome da Receita</label>
                <input type="text" class="form-control" id="nome" name="nome" required maxlength="100">
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="categoria" class="form-label">Categoria</label>
                    <select class="form-select" id="categoria" name="categoria" required>
                        <option value="" disabled selected>Escolha uma opção...</option>
                        <!-- Ordem Lógica por Tipo de Prato -->
                        <option value="Entrada">Entrada</option>
                        <option value="Sopa">Sopa</option>
                        <option value="Salada">Salada</option>
                        <option value="Carne">Carne</option>
                        <option value="Peixe">Peixe</option>
                        <option value="Marisco">Marisco</option>
                        <option value="Vegetariano">Vegetariano</option>
                        <option value="Acompanhamento">Acompanhamento</option>
                        <option value="Doce">Doce</option>
                        <option value="Airfryer">Airfryer</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="dificuldade" class="form-label">Dificuldade</label>
                    <select class="form-select" id="dificuldade" name="dificuldade" required>
                        <option value="" disabled selected>Escolha uma opção...</option>
                        <option value="Fácil">Fácil</option>
                        <option value="Média">Média</option>
                        <option value="Difícil">Difícil</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="tempo_preparo" class="form-label">Tempo de Preparo</label>
                    <input type="text" class="form-control" id="tempo_preparo" name="tempo_preparo" placeholder="Ex: 45 min" maxlength="20">
                </div>
            </div>

            <div class="mb-3">
                <label for="ingredientes" class="form-label">Ingredientes</label>
                <textarea class="form-control auto-growing-textarea" id="ingredientes" name="ingredientes" rows="4" placeholder="Um ingrediente por linha, por exemplo:&#10;2 ovos&#10;50ml de leite&#10;Sal e pimenta a gosto" required></textarea>
                <div class="form-text">Pode colar uma lista de ingredientes. Separe-os por linha ou por vírgula.</div>
            </div>

            <div class="mb-3">
                <label for="instrucoes" class="form-label">Instruções</label>
                <textarea class="form-control auto-growing-textarea" id="instrucoes" name="instrucoes" rows="6" placeholder="Um passo por linha, por exemplo:&#10;1. Bata os ovos com o leite.&#10;2. Tempere com sal e pimenta.&#10;3. Aqueça a manteiga numa frigideira." required></textarea>
                <div class="form-text">Pode colar os passos da receita. Separe-os por linha ou por vírgula.</div>
            </div>

            <div class="mb-4">
                <label for="link_receita" class="form-label">Link da Receita (Opcional)</label>
                <input type="url" class="form-control" id="link_receita" name="link_receita" placeholder="https://exemplo.com/receita" maxlength="500">
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-warning btn-lg">Enviar Sugestão</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('suggestion-form');
    const messageDisplay = document.getElementById('message-display');

    form.addEventListener('submit', async function(event) {
        event.preventDefault(); // Impede o envio tradicional do formulário

        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'A enviar...';

        // Recolhe os dados dos campos normais
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Validação para garantir que pelo menos um ingrediente e uma instrução foram adicionados
        if (!data.ingredientes.trim() || !data.instrucoes.trim()) {
            alert('Por favor, adicione pelo menos um ingrediente e uma instrução.');
            submitButton.disabled = false;
            submitButton.textContent = 'Enviar Sugestão';
            return;
        }

        try {
            const response = await fetch('/api/suggestions/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();

            if (response.ok) {
                // SUCESSO: A API respondeu com um status 2xx.
                alert("Obrigado pela sua contribuição! A sua sugestão foi enviada com sucesso.");
                form.reset(); // Limpa o formulário.
            } else {
                // ERRO DA API: A API respondeu com um erro (ex: 400, 500).
                // Mostra a mensagem de erro específica vinda do servidor.
                alert(result.error || 'Não foi possível enviar a sugestão. Verifique os dados e tente novamente.');
            }

        } catch (error) {
            // ERRO DE REDE: O fetch falhou (ex: sem internet).
            console.error('Erro ao enviar sugestão:', error);
            alert('Ocorreu um erro de comunicação. Por favor, verifique a sua ligação e tente novamente.');
        } finally {
            // Reativa o botão
            submitButton.disabled = false;
            submitButton.textContent = 'Enviar Sugestão';
        }
    });

    // Lógica para fazer as textareas crescerem automaticamente
    const textareas = document.querySelectorAll('.auto-growing-textarea');
    textareas.forEach(textarea => {
        function autoGrow() {
            textarea.style.height = 'auto'; // Reseta a altura
            textarea.style.height = (textarea.scrollHeight) + 'px'; // Define a altura com base no conteúdo
        }
        textarea.addEventListener('input', autoGrow);
        // Chama a função uma vez para ajustar o tamanho inicial caso haja conteúdo pré-preenchido
        autoGrow();
    });

});
</script>
{% endblock %}